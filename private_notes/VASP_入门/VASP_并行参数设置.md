# VASP并行参数设置

VASP 5.x 默认并行参数（`KPAR=1` 和 `NCORE=1`）可能效率较低，尤其对于多节点并行任务。
合理的 `KPAR` 和 `NCORE` 设置能够有效提升计算性能。

在 VASP 6.x 及以后版本支持混合 MPI/OpenMP 并行模式（混合并行），其中 `NCORE` 参数在开启 OpenMP 时被 `OMP_NUM_THREADS` 替代（在提交脚本 `runvasp.pbs` 中进行设置）。
混合并行有助于降低 MPI 进程间的通信开销，但在少于 10 个节点的情况下，并行效率提升有限。

在 VASP-GPU（acc 版本）中，`NCORE` 的默认值为 1，此时计算效率通常最高。
其他 `NCORE` 设置无效，因为 GPU 版本自动将 `NCORE` 设置为 1。

Gamma 版本的 VASP (通常是 `vasp_gam` 可执行文件) 主要用于单个 k 点（Gamma 点）计算，并且不支持多 k 点并行，适合大体系（如大分子、表面、界面及非周期性结构等）。
与标准版（`vasp_std`）相比，Gamma 版本通过去除波函数的复数部分计算，显著降低了内存使用量并提高了计算效率。
在 Gamma 版本中，`KPAR` 参数只能设置为 1，因为没有多 k 点可以进行并行化。
若将 `KPAR` 设置为大于 1 的值，VASP 会自动调整为 1，设置更大的 KPAR 可能导致资源浪费，并降低计算效率。

## 根据体系大小调节并行参数

`KPAR` 控制同时计算多少个 k 点，决定了 k 点的并行策略。
`KPAR` 的最大值应设为布里渊区不可约 k 点数（`NKPTS`），但最佳设置应为能整除 `NKPTS` 的值，以平衡负载。

`NPAR` 决定每个 k 点计算多少条能带（轨道），从而控制能带并行的策略。
`NCORE` 则决定每条带由多少个核来计算，影响轨道的并行度。
通常 `NCORE` 设置为 `总核数 / KPAR / NPAR` 的值。
其中，总核数指的是使用的节点数乘以每个节点的核数。

需要注意，`NPAR` 和 `NCORE` 并非严格互斥（只能设置一个）。
两者同时设置时，`NPAR` 会根据 `NCORE` 的值自动调整，以确保 `NPAR*NCORE` 的值等于总核数。


- 小体系（原子数少、k 点较多、能带少）：
由于 k 点数目较多而能带数较少，建议 `KPAR` 尽可能设大，而 `NPAR` 设为 1，以最大化 k 点的并行效率。

- 中等规模体系（20 到 100 原子）：
此类体系 k 点数目较少（通常 5~50 个），但能带数较多（>100 条）。
因此，推荐将 `KPAR` 设为节点数以平衡各节点间的负载，同时 `NPAR` 设置为合适的值（如 2、4 等），以提高能带并行效率。
过高的 `KPAR` 值会增加内存消耗，因此需要根据系统实际情况调节。

## 根据输出结果调节并行参数

如果不确定并行参数的最佳设置，可以先不设置它们，然后运行两到三个离子步。
使用以下命令查看体系的关键参数和各步骤耗时：

- `grep LOOP OUTCAR`：查看电子步（LOOP）和离子步（LOOP+）的耗时，判断计算过程中的瓶颈。

- `grep NKPTS OUTCAR`：检查体系的 k 点数目，进一步确认 `KPAR` 设置。

- `grep NBANDS OUTCAR`：检查体系的能带数目（`NBANDS`），用于后续 `NPAR` 或 `NCORE` 的设置。

根据 `NKPTS` 的值来确定 `KPAR`。
`KPAR` 的值应使 `NKPTS/KPAR` 为整数，这样可以保证 k 点并行的负载均衡。
`KPAR` 的值通常建议设置为 2 的倍数（如 1、2、4、8 等），以优化 MPI 通信效率。
`NCORE` 的设置需满足 `NCORE × KPAR ≈ CPU 核心数` 的条件，但不一定需要完全相等。

例如，若 `KPAR = 3` 且 `NCORE = 18`，则 3 × 18 = 54，即使用 54 核，而如果集群节点中总核心数是 56，也是可接受的。

在设置好 `KPAR` 和 `NCORE` 后，可以再次运行两到三个离子步，使用 `grep LOOP OUTCAR` 查看电子步和离子步的耗时变化。
如果电子步耗时较长，建议增加 `KPAR` 或减少 `NCORE` 来进一步优化计算效率；若离子步耗时较长，则可能需要调整节点数或优化 I/O 参数。